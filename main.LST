C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "12864.h"
   3          #include "key.h"
   4          #include "intrins.h"
   5          typedef unsigned char BYTE;
   6          typedef unsigned int WORD;
   7          
   8          
   9          uchar code table1[]="1.密码开锁";
  10          uchar code table2[]="2.指纹开锁";
  11          uchar code table3[]="3.蓝牙开锁";
  12          uchar code table4[]="4.设置";
  13          uchar code table5[]="5.确定";
  14          uchar code table6[]="10.delete";
  15          uchar code table7[]="11确认";
  16          uchar code table8[]="12退出";
  17          uchar code table9[]="    开锁成功    ";
  18          
  19          
  20          uchar code table11[]="  请输入密码    ";
  21          uchar code table21[]="  请输入指纹    ";
  22          uchar code table31[]="  蓝牙开锁中    ";
  23          uchar code table32[]="  蓝牙开锁成功  ";
  24          uchar code table33[]="  蓝牙开锁失败  ";
  25          uchar code table41[]="    设置界面  ";
  26          uchar code table00[]="                  ";
  27          
  28          
  29          
  30          uchar  index=0;
  31          uchar mima[6]={0};                //密码
  32          uchar mima_edit[6]={0xff,0xff,0xff,0xff,0xff,0xff};       //用户输入的密码
  33          
  34          uchar buff_lanya[20];
  35          uchar num_laya_i=0;
  36          uchar num_laya_bao=0;
  37          uchar flag_lanyakaisuo_bao=0;//数据包已经足够，可以判断开锁
  38          uchar flag_success_laya=0;
  39          
  40          
  41          void UsartConfiguration();
  42          void sendchar(uchar ch);
  43          void sendstring(uchar *s);
  44          
  45          uchar flag_function=0;
  46          uchar flag_mimakaisuo=0;
  47          uchar flag_zhiwenkaisuo=0;
  48          uchar flag_lanyakaisuo=0;
  49          uchar flag_shezhijiemian=0;
  50          uchar checkmima(uchar mima[],uchar mima_edit[]);
  51          uchar checklanay(uchar buff_lanya[20]);
  52          void init();
  53          
  54          void main()
  55          {
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 2   

  56   1         init();//初始化，读取密码
  57   1      //   display_init_lcd();//显示初始界面
  58   1      //   /*
  59   1      //     1 密码解锁
  60   1      //       2 蓝牙解锁
  61   1      //       3 指纹解锁
  62   1      //       4 设置
  63   1      //   */
  64   1      //   key_num=get_keynum();
  65   1      //      lcd12864_show_string(0,1,table1);
  66   1      //      lcd12864_show_string(1,1,table2);
  67   1      //      lcd12864_show_string(2,1,table3);
  68   1      //      lcd12864_show_string(3,1,table4);
  69   1      //      lcd12864_show_string(3,5,table5);
  70   1      //
  71   1              UsartConfiguration();
  72   1              while(1)
  73   1              {               uchar i;
  74   2                       KeyDown();
  75   2                      
  76   2                       //一级菜单
  77   2                       if(flag_mimakaisuo==0&&flag_zhiwenkaisuo==0&&flag_lanyakaisuo==0&&flag_shezhijiemian==0)
  78   2                       {
  79   3                       if(KeyValue==0 )
  80   3                       {
  81   4                              flag_function=1;
  82   4                              lcd12864_show_char(0,0,'*');
  83   4                              lcd12864_show_char(1,0,' ');
  84   4                              lcd12864_show_char(2,0,' ');
  85   4                              lcd12864_show_char(3,0,' ');
  86   4                              lcd12864_show_char(3,4,' ');
  87   4                                                      
  88   4                       }      
  89   3      
  90   3                        if(KeyValue==1)
  91   3                       {
  92   4                              flag_function=2;
  93   4                              lcd12864_show_char(0,0,' ');
  94   4                              lcd12864_show_char(1,0,'*') ;
  95   4                              lcd12864_show_char(2,0,' ');
  96   4                              lcd12864_show_char(3,0,' ');
  97   4                              lcd12864_show_char(3,4,' ');
  98   4                                                      
  99   4                      
 100   4                       }      
 101   3      
 102   3                        if(KeyValue==2)
 103   3                       {
 104   4                              flag_function=3;
 105   4                              lcd12864_show_char(0,0,' ');
 106   4                              lcd12864_show_char(1,0,' ') ;
 107   4                              lcd12864_show_char(2,0,'*');
 108   4                              lcd12864_show_char(3,0,' ');
 109   4                              lcd12864_show_char(3,4,' ');
 110   4              
 111   4                       }      
 112   3      
 113   3                        if(KeyValue==3)
 114   3                       {
 115   4                              flag_function=4;
 116   4                              lcd12864_show_char(0,0,' ');
 117   4                              lcd12864_show_char(1,0,' ');
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 3   

 118   4                              lcd12864_show_char(2,0,' ');
 119   4                              lcd12864_show_char(3,0,'*');
 120   4                              lcd12864_show_char(3,4,' ');
 121   4      
 122   4                       }
 123   3                              
 124   3      
 125   3                        if( KeyValue==4 && flag_function==1 )
 126   3                       {
 127   4                         
 128   4                              flag_mimakaisuo=1;
 129   4                   lcd12864_show_string(0,0,table11);
 130   4                   lcd12864_show_string(1,0,table00);
 131   4                   lcd12864_show_string(2,1,table6);
 132   4               lcd12864_show_string(3,1,table7);
 133   4                       lcd12864_show_string(3,5,table8);
 134   4           
 135   4                      }       
 136   3      
 137   3                        if( KeyValue==4 && flag_function==2 )
 138   3                       {
 139   4                         
 140   4                          //lcd12864_init();
 141   4                              flag_zhiwenkaisuo=1;
 142   4                   //   lcd12864_show_string(0,0,table21);
 143   4                    //  lcd12864_show_string(1,0,table00);
 144   4                    //  lcd12864_show_string(2,0,table00);
 145   4                //  lcd12864_show_string(3,0,table00);
 146   4           
 147   4                      }       
 148   3      
 149   3                        if( KeyValue==4 && flag_function==3 )
 150   3                       {
 151   4                         
 152   4                          //lcd12864_init();
 153   4                              flag_lanyakaisuo=1;
 154   4                      lcd12864_show_string(0,0,table31);
 155   4                      lcd12864_show_string(1,0,table00);
 156   4                      lcd12864_show_string(2,0,table00);
 157   4                  lcd12864_show_string(3,0,table00);
 158   4                              lcd12864_show_string(3,5,table8);
 159   4                      }       
 160   3      
 161   3                        if( KeyValue==4 && flag_function==4 )
 162   3                       {
 163   4                         
 164   4                          //lcd12864_init();
 165   4                              flag_shezhijiemian=1;
 166   4                      lcd12864_show_string(0,0,table41);
 167   4                      lcd12864_show_string(1,0,table00);
 168   4                      lcd12864_show_string(2,0,table00);
 169   4                  lcd12864_show_string(3,0,table00);
 170   4           
 171   4                      }
 172   3                         KeyValue=17;
 173   3              }
 174   2      
 175   2                //二级菜单 ――――密码开锁界面
 176   2                 if(flag_mimakaisuo==1)
 177   2                 {
 178   3                    if(KeyValue!=17)
 179   3                        {              
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 4   

 180   4                                        if(KeyValue<10)
 181   4                                        {
 182   5                                            if(index<6)
 183   5                                                {
 184   6                                                         mima_edit[index++]=KeyValue;
 185   6                                                         lcd12864_show_char(1,index-1,KeyValue+'0');
 186   6                                                         KeyValue=17;
 187   6                                                }
 188   5                                              
 189   5                                        }else
 190   4                                        {
 191   5                                          if(KeyValue==10)
 192   5                                              {               KeyValue=17;
 193   6                                                 //删除一位
 194   6                                                 if(index>0 && index<=6)
 195   6                                                 {
 196   7                                                      mima_edit[index-1]=0Xff;
 197   7                                                  lcd12864_show_char(1,index-1,' ');
 198   7                                                  index-=1;
 199   7                                              
 200   7                                                 }
 201   6                                                 
 202   6                                                 else if(index>6)
 203   6                                                 {   
 204   7                                                      index=6;
 205   7                                                  lcd12864_show_char(1,index-1,' ');
 206   7                                                  mima_edit[index-1]=0Xff;
 207   7                                                  index-=1;
 208   7                                                 
 209   7                                                 }else
 210   6                                                 {
 211   7                                                 //index为0，不操作
 212   7                                                 }
 213   6                                                 
 214   6                                              }
 215   5                                              
 216   5                                              else if(KeyValue==11)
 217   5                                              {
 218   6                                               //确认
 219   6                                                KeyValue=17;
 220   6                                                 if(checkmima(mima,mima_edit))
 221   6                                                 {
 222   7                                                        //密码正确开锁,提示
 223   7                                  lcd12864_show_string(0,0,table9);                
 224   7                                  lcd12864_show_string(1,0,table00);
 225   7                                  lcd12864_show_string(2,0,table00);
 226   7                              lcd12864_show_string(3,0,table00);
 227   7                                                      sendstring("#C!");//成功回复
 228   7                                                      sendstring("#C!");
 229   7                                                      sendstring("#C!");
 230   7                                                      sendstring("#C!");
 231   7                                                      sendstring("#C!");
 232   7                                                       
 233   7                                                 } else
 234   6                                                 {
 235   7                                                       //密码错误，提示,并清空密码
 236   7                                                       uchar i;
 237   7                                                       for(i=0;i<6;i++)
 238   7                                                       lcd12864_show_char(1,i,' ');
 239   7                                                       index=0;
 240   7                                                       sendstring("#S!");//失败回复
 241   7                                                       sendstring("#S!");
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 5   

 242   7                                                       sendstring("#S!");
 243   7                                                       sendstring("#S!");
 244   7                                                       sendstring("#S!");
 245   7                                                 }
 246   6                                                 //清除输入的密码
 247   6                                                      mima_edit[0]=0xff;
 248   6                                                      mima_edit[1]=0xff;
 249   6                                                      mima_edit[2]=0xff;
 250   6                                                      mima_edit[3]=0xff;
 251   6                                                      mima_edit[4]=0xff;
 252   6                                                      mima_edit[5]=0xff;
 253   6                                              }
 254   5      
 255   5                                              else if(KeyValue==12)
 256   5                                              {
 257   6                                                //退出
 258   6                                                 KeyValue=17;
 259   6                                                 flag_mimakaisuo=0;
 260   6                                                 lcd12864_show_string(0,1,table1);
 261   6                                 lcd12864_show_string(1,1,table2);
 262   6                                 lcd12864_show_string(2,1,table3);
 263   6                             lcd12864_show_string(3,1,table4);
 264   6                             lcd12864_show_string(3,5,table5);
 265   6      
 266   6                                                 //清除输入的密码
 267   6                                                  mima_edit[0]=0xff;
 268   6                                                      mima_edit[1]=0xff;
 269   6                                                      mima_edit[2]=0xff;
 270   6                                                      mima_edit[3]=0xff;
 271   6                                                      mima_edit[4]=0xff;
 272   6                                                      mima_edit[5]=0xff;
 273   6                                              
 274   6                                              }else
 275   5                                              {
 276   6                                                //此种按键码无效
 277   6                                                 KeyValue=17;
 278   6                                              }
 279   5                                        }
 280   4      
 281   4                               
 282   4                        }
 283   3                       
 284   3      
 285   3                 }
 286   2      
 287   2                      //二级菜单 ――――指纹开锁界面
 288   2                 if(flag_zhiwenkaisuo==1)
 289   2                 {
 290   3                 
 291   3                 }
 292   2      
 293   2                      //二级菜单 ――――蓝牙开锁界面
 294   2                 if(flag_lanyakaisuo==1)
 295   2                 {
 296   3                              if(flag_lanyakaisuo_bao)
 297   3                              {
 298   4                                       if(checklanay(buff_lanya))
 299   4                                       {
 300   5                                       //开锁成功
 301   5                             lcd12864_show_string(0,1,table32);
 302   5                                 lcd12864_show_string(1,1,table00);
 303   5                                 lcd12864_show_string(2,1,table00);
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 6   

 304   5                             lcd12864_show_string(3,1,table00);
 305   5                         
 306   5      
 307   5                                       }
 308   4                                       else
 309   4                                       {
 310   5                                        //开锁失败
 311   5                                             lcd12864_show_string(0,1,table33);
 312   5                                 lcd12864_show_string(1,1,table00);
 313   5                                 lcd12864_show_string(2,1,table00);
 314   5                             lcd12864_show_string(3,1,table00);
 315   5      
 316   5                                       }
 317   4                                      
 318   4                                       for(i=0;i<20;i++)
 319   4                                       {
 320   5                                        buff_lanya[i]=0;
 321   5                                        }
 322   4                                      
 323   4                                       num_laya_i=0;
 324   4                                       num_laya_bao=0;
 325   4                                       flag_lanyakaisuo_bao=0;//数据包已经足够，可以判断开锁
 326   4                                       flag_success_laya=0;
 327   4                              }
 328   3                      if(KeyValue==12)
 329   3                              {
 330   4                                             flag_lanyakaisuo=0;
 331   4                                             KeyValue=17;
 332   4                                                 flag_lanyakaisuo=0;
 333   4                                                 lcd12864_show_string(0,1,table1);
 334   4                                 lcd12864_show_string(1,1,table2);
 335   4                                 lcd12864_show_string(2,1,table3);
 336   4                             lcd12864_show_string(3,1,table4);
 337   4                             lcd12864_show_string(3,5,table5);
 338   4      
 339   4                              }
 340   3      
 341   3                 }
 342   2      
 343   2                      //二级菜单 ――――设置界面
 344   2                 if(flag_shezhijiemian==1)
 345   2                 {
 346   3                 
 347   3                 }
 348   2      }
 349   1      
 350   1         }
 351          
 352           uchar checkmima(uchar mima[],uchar mima_edit[])
 353           {
 354   1                  uchar i=0,j=0;
 355   1                      for(i=0;i<6;i++)
 356   1                      {
 357   2                         if(mima[i]==mima_edit[i])
 358   2                         {
 359   3                                       j++;
 360   3                         }
 361   2                      }
 362   1                      
 363   1                      if(j==6)
 364   1                         return 1;
 365   1                      else
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 7   

 366   1                              return 0;
 367   1       }
 368          
 369          
 370          
 371          void init()
 372          {
 373   1          lcd12864_init();
 374   1              lcd12864_show_string(0,1,table1);
 375   1              lcd12864_show_string(1,1,table2);
 376   1              lcd12864_show_string(2,1,table3);
 377   1              lcd12864_show_string(3,1,table4);
 378   1              lcd12864_show_string(3,5,table5);
 379   1              mima[0]=1;
 380   1              mima[1]=2;
 381   1              mima[2]=3;
 382   1              mima[3]=4;
 383   1              mima[4]=5;
 384   1              mima[5]=6;
 385   1      
 386   1      }
 387          
 388          
 389          
 390          void UsartConfiguration()
 391          {
 392   1      
 393   1              SCON=0X50;                      //设置为工作方式1
 394   1              TMOD=0X20;                      //设置计数器工作方式2
 395   1              PCON=0X00;                      //波特率加倍
 396   1              TH1=0XFd;                   //计数器初始值设置，注意波特率是9600的
 397   1              TL1=0XFd;
 398   1              ES=1;                                           //打开接收中断
 399   1              EA=1;                                           //打开总中断
 400   1              TR1=1;                                      //打开计数器
 401   1      }
 402          
 403          void Usart() interrupt 4
 404          {
 405   1              uchar receiveData;
 406   1              receiveData=SBUF; //接收到的数据
 407   1                      //蓝牙开锁界面
 408   1              
 409   1                 if(flag_lanyakaisuo_bao==0 && flag_lanyakaisuo==1)
 410   1                 {
 411   2                         buff_lanya[num_laya_i++]= receiveData;
 412   2                         if(receiveData=='#')
 413   2                              num_laya_bao++; 
 414   2                              if(num_laya_bao>2)
 415   2                                 flag_lanyakaisuo_bao=1;  
 416   2                 }
 417   1                      //      指纹开锁界面
 418   1                 if(flag_zhiwenkaisuo==1)
 419   1                 {
 420   2                 
 421   2                 }
 422   1              RI = 0;           //清除接收中断标志位
 423   1              SBUF=receiveData; //将接收到的数据放入到发送寄存器
 424   1              while(!TI);               //等待发送数据完成
 425   1              TI=0;                     //清除发送完成标志位
 426   1      }
 427          void sendchar(uchar ch)
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 19:05:23 PAGE 8   

 428          {
 429   1              SBUF=ch; //将接收到的数据放入到发送寄存器
 430   1              while(!TI);               //等待发送数据完成
 431   1              TI=0;   
 432   1      }
 433          void sendstring(uchar *s)
 434          {
 435   1         while (*s)              
 436   1          {
 437   2              sendchar(*s++);     
 438   2          }
 439   1      }
 440          uchar checklanay(uchar buff_lanya[])
 441          {
 442   1              uchar i=0;
 443   1                 for(i=0;i<20-3;i++)
 444   1                 {
 445   2                         if(buff_lanya[i]=='#')
 446   2                         {
 447   3                             if(buff_lanya[i+1]=='K'&&buff_lanya[i+2]=='!')
 448   3                                 {
 449   4                                        return 1;
 450   4                                 }
 451   3                         }
 452   2                 }
 453   1                 return 0;
 454   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1435    ----
   CONSTANT SIZE    =    215    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     42      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
