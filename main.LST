C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "12864.h"
   3          #include "key.h"
   4          #include "intrins.h"
   5          typedef unsigned char BYTE;
   6          typedef unsigned int WORD;
   7          
   8          
   9          uchar code table1[]="1.密码开锁";
  10          uchar code table2[]="2.指纹开锁";
  11          uchar code table3[]="3.蓝牙开锁";
  12          uchar code table4[]="4.设置";
  13          uchar code table5[]="5.确定";
  14          uchar code table6[]="10.delete";
  15          uchar code table7[]="11确认";
  16          uchar code table8[]="12退出";
  17          uchar code table9[]="    开锁成功    ";
  18          
  19          uchar code table11[]="  请输入密码    ";
  20          uchar code table21[]="  请输入指纹    ";
  21          uchar code table31[]="  请连接蓝牙设备";
  22          uchar code table41[]="    设置界面  ";
  23          uchar code table00[]="                  ";
  24          
  25          uchar  index=0;
  26          uchar mima[6]={0};                //密码
  27          uchar mima_edit[6]={0xff,0xff,0xff,0xff,0xff,0xff};       //用户输入的密码
  28          
  29          
  30          #define FOSC 11059200L      //System frequency
  31          #define BAUD 9600           //UART baudrate
  32          
  33          /*Define UART parity mode*/
  34          #define NONE_PARITY     0   //None parity
  35          #define ODD_PARITY      1   //Odd parity
  36          #define EVEN_PARITY     2   //Even parity
  37          #define MARK_PARITY     3   //Mark parity
  38          #define SPACE_PARITY    4   //Space parity
  39          
  40          #define PARITYBIT NONE_PARITY   //Testing even parity
  41          
  42          bit busy;
  43          
  44          void SendData(BYTE dat);
  45          void SendString(char *s);
  46          
  47          
  48          uchar flag_function=0;
  49          uchar flag_mimakaisuo=0;
  50          uchar flag_zhiwenkaisuo=0;
  51          uchar flag_lanyakaisuo=0;
  52          uchar flag_shezhijiemian=0;
  53          uchar checkmima(uchar mima[],uchar mima_edit[]);
  54          void init();
  55          
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 2   

  56          void main()
  57          {
  58   1         init();//初始化，读取密码
  59   1      //   display_init_lcd();//显示初始界面
  60   1      //   /*
  61   1      //     1 密码解锁
  62   1      //       2 蓝牙解锁
  63   1      //       3 指纹解锁
  64   1      //       4 设置
  65   1      //   */
  66   1      //   key_num=get_keynum();
  67   1      //      lcd12864_show_string(0,1,table1);
  68   1      //      lcd12864_show_string(1,1,table2);
  69   1      //      lcd12864_show_string(2,1,table3);
  70   1      //      lcd12864_show_string(3,1,table4);
  71   1      //      lcd12864_show_string(3,5,table5);
  72   1      //
  73   1              
  74   1              while(1)
  75   1              {
  76   2                       KeyDown();
  77   2                              
  78   2                       //一级菜单
  79   2                       if(flag_mimakaisuo==0&&flag_zhiwenkaisuo==0&&flag_lanyakaisuo==0&&flag_shezhijiemian==0)
  80   2                       {
  81   3                       if(KeyValue==0 )
  82   3                       {
  83   4                              flag_function=1;
  84   4                              lcd12864_show_char(0,0,'*');
  85   4                              lcd12864_show_char(1,0,' ');
  86   4                              lcd12864_show_char(2,0,' ');
  87   4                              lcd12864_show_char(3,0,' ');
  88   4                              lcd12864_show_char(3,4,' ');
  89   4                                                      
  90   4                       }      
  91   3      
  92   3                        if(KeyValue==1)
  93   3                       {
  94   4                              flag_function=2;
  95   4                              lcd12864_show_char(0,0,' ');
  96   4                              lcd12864_show_char(1,0,'*') ;
  97   4                              lcd12864_show_char(2,0,' ');
  98   4                              lcd12864_show_char(3,0,' ');
  99   4                              lcd12864_show_char(3,4,' ');
 100   4                                                      
 101   4                      
 102   4                       }      
 103   3      
 104   3                        if(KeyValue==2)
 105   3                       {
 106   4                              flag_function=3;
 107   4                              lcd12864_show_char(0,0,' ');
 108   4                              lcd12864_show_char(1,0,' ') ;
 109   4                              lcd12864_show_char(2,0,'*');
 110   4                              lcd12864_show_char(3,0,' ');
 111   4                              lcd12864_show_char(3,4,' ');
 112   4              
 113   4                       }      
 114   3      
 115   3                        if(KeyValue==3)
 116   3                       {
 117   4                              flag_function=4;
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 3   

 118   4                              lcd12864_show_char(0,0,' ');
 119   4                              lcd12864_show_char(1,0,' ');
 120   4                              lcd12864_show_char(2,0,' ');
 121   4                              lcd12864_show_char(3,0,'*');
 122   4                              lcd12864_show_char(3,4,' ');
 123   4      
 124   4                       }
 125   3                              
 126   3      
 127   3                        if( KeyValue==4 && flag_function==1 )
 128   3                       {
 129   4                         
 130   4                              flag_mimakaisuo=1;
 131   4                   lcd12864_show_string(0,0,table11);
 132   4                   lcd12864_show_string(1,0,table00);
 133   4                   lcd12864_show_string(2,1,table6);
 134   4               lcd12864_show_string(3,1,table7);
 135   4                       lcd12864_show_string(3,5,table8);
 136   4           
 137   4                      }       
 138   3      
 139   3                        if( KeyValue==4 && flag_function==2 )
 140   3                       {
 141   4                         
 142   4                          //lcd12864_init();
 143   4                              flag_zhiwenkaisuo=1;
 144   4                   //   lcd12864_show_string(0,0,table21);
 145   4                    //  lcd12864_show_string(1,0,table00);
 146   4                    //  lcd12864_show_string(2,0,table00);
 147   4                //  lcd12864_show_string(3,0,table00);
 148   4           
 149   4                      }       
 150   3      
 151   3                        if( KeyValue==4 && flag_function==3 )
 152   3                       {
 153   4                         
 154   4                          //lcd12864_init();
 155   4                              flag_lanyakaisuo=1;
 156   4                      lcd12864_show_string(0,0,table31);
 157   4                      lcd12864_show_string(1,0,table00);
 158   4                      lcd12864_show_string(2,0,table00);
 159   4                  lcd12864_show_string(3,0,table00);
 160   4           
 161   4                      }       
 162   3      
 163   3                        if( KeyValue==4 && flag_function==4 )
 164   3                       {
 165   4                         
 166   4                          //lcd12864_init();
 167   4                              flag_shezhijiemian=1;
 168   4                      lcd12864_show_string(0,0,table41);
 169   4                      lcd12864_show_string(1,0,table00);
 170   4                      lcd12864_show_string(2,0,table00);
 171   4                  lcd12864_show_string(3,0,table00);
 172   4           
 173   4                      }
 174   3                         KeyValue=17;
 175   3              }
 176   2      
 177   2                //二级菜单 ――――密码开锁界面
 178   2                 if(flag_mimakaisuo==1)
 179   2                 {
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 4   

 180   3                    if(KeyValue!=17)
 181   3                        {              
 182   4                                        if(KeyValue<10)
 183   4                                        {
 184   5                                            if(index<6)
 185   5                                                {
 186   6                                                         mima_edit[index++]=KeyValue;
 187   6                                                         lcd12864_show_char(1,index-1,KeyValue+'0');
 188   6                                                         KeyValue=17;
 189   6                                                }
 190   5                                              
 191   5                                        }else
 192   4                                        {
 193   5                                          if(KeyValue==10)
 194   5                                              {               KeyValue=17;
 195   6                                                 //删除一位
 196   6                                                 if(index>0 && index<=6)
 197   6                                                 {
 198   7                                                      mima_edit[index-1]=0Xff;
 199   7                                                  lcd12864_show_char(1,index-1,' ');
 200   7                                                  index-=1;
 201   7                                              
 202   7                                                 }
 203   6                                                 
 204   6                                                 else if(index>6)
 205   6                                                 {   
 206   7                                                      index=6;
 207   7                                                  lcd12864_show_char(1,index-1,' ');
 208   7                                                  mima_edit[index-1]=0Xff;
 209   7                                                  index-=1;
 210   7                                                 
 211   7                                                 }else
 212   6                                                 {
 213   7                                                 //index为0，不操作
 214   7                                                 }
 215   6                                                 
 216   6                                              }
 217   5                                              
 218   5                                              else if(KeyValue==11)
 219   5                                              {
 220   6                                               //确认
 221   6                                                KeyValue=17;
 222   6                                                 if(checkmima(mima,mima_edit))
 223   6                                                 {
 224   7                                                        //密码正确开锁,提示
 225   7                                  lcd12864_show_string(0,0,table9);                
 226   7                                  lcd12864_show_string(1,0,table00);
 227   7                                  lcd12864_show_string(2,0,table00);
 228   7                              lcd12864_show_string(3,0,table00);
 229   7                                                       
 230   7                                                 } else
 231   6                                                 {
 232   7                                                       //密码错误，提示,并清空密码
 233   7                                                       uchar i;
 234   7                                                       for(i=0;i<6;i++)
 235   7                                                       lcd12864_show_char(1,i,' ');
 236   7                                                       index=0;
 237   7                                                      
 238   7                                                 }
 239   6                                                 //清除输入的密码
 240   6                                                      mima_edit[0]=0xff;
 241   6                                                      mima_edit[1]=0xff;
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 5   

 242   6                                                      mima_edit[2]=0xff;
 243   6                                                      mima_edit[3]=0xff;
 244   6                                                      mima_edit[4]=0xff;
 245   6                                                      mima_edit[5]=0xff;
 246   6                                              }
 247   5      
 248   5                                              else if(KeyValue==12)
 249   5                                              {
 250   6                                                //退出
 251   6                                                 KeyValue=17;
 252   6                                                 flag_mimakaisuo=0;
 253   6                                                 lcd12864_show_string(0,1,table1);
 254   6                                 lcd12864_show_string(1,1,table2);
 255   6                                 lcd12864_show_string(2,1,table3);
 256   6                             lcd12864_show_string(3,1,table4);
 257   6                             lcd12864_show_string(3,5,table5);
 258   6      
 259   6                                                 //清除输入的密码
 260   6                                                  mima_edit[0]=0xff;
 261   6                                                      mima_edit[1]=0xff;
 262   6                                                      mima_edit[2]=0xff;
 263   6                                                      mima_edit[3]=0xff;
 264   6                                                      mima_edit[4]=0xff;
 265   6                                                      mima_edit[5]=0xff;
 266   6                                              
 267   6                                              }else
 268   5                                              {
 269   6                                                //此种按键码无效
 270   6                                                 KeyValue=17;
 271   6                                              }
 272   5                                        }
 273   4      
 274   4                               
 275   4                        }
 276   3                       
 277   3      
 278   3                 }
 279   2      
 280   2                      //二级菜单 ――――指纹开锁界面
 281   2                 if(flag_zhiwenkaisuo==1)
 282   2                 {
 283   3                 
 284   3                 }
 285   2      
 286   2                      //二级菜单 ――――蓝牙开锁界面
 287   2                 if(flag_lanyakaisuo==1)
 288   2                 {
 289   3                 
 290   3                 }
 291   2      
 292   2                      //二级菜单 ――――设置界面
 293   2                 if(flag_shezhijiemian==1)
 294   2                 {
 295   3                 
 296   3                 }
 297   2      
 298   2      
 299   2                      
 300   2              //       if()
 301   2      
 302   2      
 303   2      //              if(key_num==1)
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 6   

 304   2      //              {  
 305   2      //                      mimajiesuo();//密码解锁,可取消
 306   2      //              }
 307   2      //              if(key_num==2)
 308   2      //              {
 309   2      //                      lanyajiesuo();//蓝牙解锁，可取消
 310   2      //              }
 311   2      //              if(key_num==3)
 312   2      //              {  
 313   2      //                      zhiwenjiesuo();//指纹解锁，可取消
 314   2      //              }
 315   2      //              if(key_num==4)
 316   2      //              {   
 317   2      //                      shezhi();          // 设置，可取消
 318   2      //              }
 319   2              }
 320   1      }
 321           uchar checkmima(uchar mima[],uchar mima_edit[])
 322           {
 323   1                  uchar i=0,j=0;
 324   1                      for(i=0;i<6;i++)
 325   1                      {
 326   2                         if(mima[i]==mima_edit[i])
 327   2                         {
 328   3                                       j++;
 329   3                         }
 330   2                      }
 331   1                      
 332   1                      if(j==6)
 333   1                         return 1;
 334   1                      else
 335   1                              return 0;
 336   1       }
 337          void init()
 338          {
 339   1          lcd12864_init();
 340   1              lcd12864_show_string(0,1,table1);
 341   1              lcd12864_show_string(1,1,table2);
 342   1              lcd12864_show_string(2,1,table3);
 343   1              lcd12864_show_string(3,1,table4);
 344   1              lcd12864_show_string(3,5,table5);
 345   1              mima[0]=1;
 346   1              mima[1]=2;
 347   1              mima[2]=3;
 348   1              mima[3]=4;
 349   1              mima[4]=5;
 350   1              mima[5]=6;
 351   1      #if (PARITYBIT == NONE_PARITY)
 352   1          SCON = 0x50;            //8-bit variable UART
 353   1      #elif (PARITYBIT == ODD_PARITY) || (PARITYBIT == EVEN_PARITY) || (PARITYBIT == MARK_PARITY)
                  SCON = 0xda;            //9-bit variable UART, parity bit initial to 1
              #elif (PARITYBIT == SPACE_PARITY)
                  SCON = 0xd2;            //9-bit variable UART, parity bit initial to 0
              #endif
 358   1      
 359   1          TMOD = 0x20;            //Set Timer1 as 8-bit auto reload mode
 360   1          TH1 = TL1 = -(FOSC/12/32/BAUD); //Set auto-reload vaule
 361   1          TR1 = 1;                //Timer1 start run
 362   1          ES = 1;                 //Enable UART interrupt
 363   1          EA = 1;                 //Open master interrupt switch
 364   1      }
 365           /*----------------------------
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 7   

 366          UART interrupt service routine
 367          ----------------------------*/
 368          void Uart_Isr() interrupt 4 using 1
 369          {
 370   1          if (RI)
 371   1          {
 372   2              RI = 0;             //Clear receive interrupt flag
 373   2                      ACC=SBUF;
 374   2                      SendData(ACC);
 375   2          }
 376   1          if (TI)
 377   1          {
 378   2              TI = 0;             //Clear transmit interrupt flag
 379   2              busy = 0;           //Clear transmit busy flag
 380   2          }
 381   1      }
 382          
 383          /*----------------------------
 384          Send a byte data to UART
 385          Input: dat (data to be sent)
 386          Output:None
 387          ----------------------------*/
 388          void SendData(BYTE dat)
 389          {
 390   1          while (busy);           //Wait for the completion of the previous data is sent
 391   1          ACC = dat;              //Calculate the even parity bit P (PSW.0)
 392   1          if (P)                  //Set the parity bit according to P
 393   1          {
 394   2      #if (PARITYBIT == ODD_PARITY)
                      TB8 = 0;            //Set parity bit to 0
              #elif (PARITYBIT == EVEN_PARITY)
                      TB8 = 1;            //Set parity bit to 1
              #endif
 399   2          }
 400   1          else
 401   1          {
 402   2      #if (PARITYBIT == ODD_PARITY)
                      TB8 = 1;            //Set parity bit to 1
              #elif (PARITYBIT == EVEN_PARITY)
                      TB8 = 0;            //Set parity bit to 0
              #endif
 407   2          }
 408   1          busy = 1;
 409   1          SBUF = ACC;             //Send data to UART buffer
 410   1      }
 411          
 412          /*----------------------------
 413          Send a string to UART
 414          Input: s (address of string)
 415          Output:None
 416          ----------------------------*/
 417          void SendString(char *s)
 418          {
 419   1          while (*s)              //Check the end of the string
 420   1          {
 421   2              SendData(*s++);     //Send current char and increment string ptr
 422   2          }
 423   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1068    ----
C51 COMPILER V9.01   MAIN                                                                  01/07/2019 14:16:09 PAGE 8   

   CONSTANT SIZE    =    173    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
