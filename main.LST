C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: E:\workspace\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "12864.h"
   3          #include "key.h"
   4          #include "intrins.h"
   5          #include "i2c.h"
   6          #include"uart.h"
   7          
   8          typedef unsigned char BYTE;
   9          typedef unsigned int WORD;
  10          
  11          
  12          uchar code table1[]="0.密码开锁";
  13          uchar code table2[]="1.指纹开锁";
  14          uchar code table3[]="2.蓝牙开锁";
  15          uchar code table4[]="3.设置";
  16          uchar code table5[]="4.确定";
  17          uchar code table6[]="10.delete   ";
  18          uchar code table7[]="11确认";
  19          uchar code table8[]="12退出";
  20          uchar code table9[]="    开锁成功    ";
  21          
  22          
  23          uchar code table11[]="  请输入密码    ";
  24          uchar code table21[]="  请输入指纹    ";
  25          uchar code table31[]="  蓝牙开锁中    ";
  26          uchar code table32[]="  蓝牙开锁成功  ";
  27          uchar code table33[]="  蓝牙开锁失败  ";
  28          uchar code table41[]="    设置界面    ";
  29          uchar code table42[]="    0.设置密码   ";
  30          uchar code table43[]="    1.设置指纹   ";
  31          uchar code table51[]="  录入成功";
  32          
  33          //uchar code table45[]="  2.设置指纹  ";
  34          uchar code table00[]="                  ";
  35          
  36          
  37          uchar zhiwen_in[12]={0xef,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x03,0x01,0x00,0x05};       //获取指纹图像
  38          uchar zhiwen_product[13]={0xEf,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x04,0x02,0x01,0x00,0x08};
  39          uchar zhiwen_product2[13]={0xEf,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x04,0x02,0x02,0x00,0x09};
  40          uchar zhiwen_match[12]={0xef,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x03,0x03,0x00,0x07};
  41          uchar zhiwen_get[12]={0xef,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x03,0x05,0x00,0x09};
  42          uchar zhiwen_str[15]={0xef,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x06,0x06,0x01,0x00,0x00,0x00,0x0d};
  43          uchar zhiwen_search[17]={0xef,0x01,0xff,0xff,0xff,0xff,0x01,0x00,0x08,0x04,0x01,0x00,0x00,0x00,0x13,0x00,0
             -x21};
  44          
  45          
  46          uchar  index=0;
  47          uchar mima[6]={0};                //密码
  48          uchar mima_edit[6]={0xff,0xff,0xff,0xff,0xff,0xff};       //用户输入的密码
  49          uchar mima_set[6]={0};
  50          uchar buff_lanya[20];
  51          uchar num_laya_i=0;
  52          uchar num_laya_bao=0;
  53          uchar flag_lanyakaisuo_bao=0;//数据包已经足够，可以判断开锁
  54          uchar flag_zhiwenkaisuo_bao=0;
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 2   

  55          uchar flag_success_laya=0;
  56          uchar shezhi_mima=0;
  57          uchar num_test=0;
  58          uchar flag_mima_set=0;
  59          uchar flag_zhiwen_set=0;
  60          
  61          void delay10ms();
  62          void UsartConfiguration();
  63          void sendchar(uchar ch);
  64          void sendstring(uchar *s);
  65          
  66          uchar buff_zhiwen[20]={1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};
  67          uchar num_zhiwen_i=0;
  68          
  69          uchar flag_function=0;
  70          uchar flag_mimakaisuo=0;
  71          uchar flag_zhiwenkaisuo=0;
  72          uchar flag_lanyakaisuo=0;
  73          uchar flag_shezhijiemian=0;
  74          uchar checkmima(uchar mima[],uchar mima_edit[]);
  75          uchar checklanay(uchar buff_lanya[20]);
  76          void init();
  77          void sendstring_zhiwen(uchar *s ,uchar length);
  78          void Delay100ms();      
  79          
  80          
  81          void main()
  82          {
  83   1           init();//初始化，读取密码
  84   1      
  85   1              delay10ms();
  86   1              UsartConfiguration();
  87   1              //EEPROM测试
  88   1      
  89   1              delay10ms();
  90   1              mima[0]=At24c02Read(0x00);
  91   1              delay10ms();
  92   1              mima[1]=At24c02Read(0x01);
  93   1              delay10ms();
  94   1              mima[2]=At24c02Read(0x02);
  95   1              delay10ms();
  96   1              mima[3]=At24c02Read(0x03);
  97   1              delay10ms();
  98   1              mima[4]=At24c02Read(0x04);
  99   1              delay10ms();
 100   1              mima[5]=At24c02Read(0x05);
 101   1      
 102   1      //      lcd12864_show_char(0,0,mima[0]+'0');
 103   1      //      lcd12864_show_char(0,1,mima[1]+'0');
 104   1      //      lcd12864_show_char(0,2,mima[2]+'0');
 105   1      //      lcd12864_show_char(0,3,mima[3]+'0');
 106   1      //      lcd12864_show_char(0,4,mima[4]+'0');
 107   1      //      lcd12864_show_char(0,5,mima[5]+'0');
 108   1      //      while(1);
 109   1              while(1)
 110   1              {               uchar i;
 111   2                       KeyDown();
 112   2                      
 113   2                       //一级菜单
 114   2                       if(flag_mimakaisuo==0&&flag_zhiwenkaisuo==0&&flag_lanyakaisuo==0&&flag_shezhijiemian==0)
 115   2                       {
 116   3                       if(KeyValue==0 )
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 3   

 117   3                       {
 118   4                              flag_function=1;
 119   4                              lcd12864_show_char(0,0,'*');
 120   4                              lcd12864_show_char(1,0,' ');
 121   4                              lcd12864_show_char(2,0,' ');
 122   4                              lcd12864_show_char(3,0,' ');
 123   4                              lcd12864_show_char(3,4,' ');
 124   4                                                      
 125   4                       }      
 126   3      
 127   3                        if(KeyValue==1)
 128   3                       {
 129   4                              flag_function=2;
 130   4                              lcd12864_show_char(0,0,' ');
 131   4                              lcd12864_show_char(1,0,'*') ;
 132   4                              lcd12864_show_char(2,0,' ');
 133   4                              lcd12864_show_char(3,0,' ');
 134   4                              lcd12864_show_char(3,4,' ');
 135   4                                                      
 136   4                      
 137   4                       }      
 138   3      
 139   3                        if(KeyValue==2)
 140   3                       {
 141   4                              flag_function=3;
 142   4                              lcd12864_show_char(0,0,' ');
 143   4                              lcd12864_show_char(1,0,' ') ;
 144   4                              lcd12864_show_char(2,0,'*');
 145   4                              lcd12864_show_char(3,0,' ');
 146   4                              lcd12864_show_char(3,4,' ');
 147   4              
 148   4                       }      
 149   3      
 150   3                        if(KeyValue==3)
 151   3                       {
 152   4                              flag_function=4;
 153   4                              lcd12864_show_char(0,0,' ');
 154   4                              lcd12864_show_char(1,0,' ');
 155   4                              lcd12864_show_char(2,0,' ');
 156   4                              lcd12864_show_char(3,0,'*');
 157   4                              lcd12864_show_char(3,4,' ');
 158   4      
 159   4                       }
 160   3                              
 161   3      
 162   3                        if( KeyValue==4 && flag_function==1 )
 163   3                       {
 164   4                         
 165   4                              flag_mimakaisuo=1;
 166   4                   lcd12864_show_string(0,0,table11);
 167   4                   lcd12864_show_string(1,0,table00);
 168   4                   lcd12864_show_string(2,1,table6);
 169   4               lcd12864_show_string(3,1,table7);
 170   4                       lcd12864_show_string(3,5,table8);
 171   4           
 172   4                      }       
 173   3      
 174   3                        if( KeyValue==4 && flag_function==2 )
 175   3                       {
 176   4                         
 177   4                          //lcd12864_init();
 178   4                              flag_zhiwenkaisuo=1;
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 4   

 179   4                   //   lcd12864_show_string(0,0,table21);
 180   4                    //  lcd12864_show_string(1,0,table00);
 181   4                    //  lcd12864_show_string(2,0,table00);
 182   4                //  lcd12864_show_string(3,0,table00);
 183   4           
 184   4                      }       
 185   3      
 186   3                        if( KeyValue==4 && flag_function==3 )
 187   3                       {
 188   4                         
 189   4                          //lcd12864_init();
 190   4                              flag_lanyakaisuo=1;
 191   4                      lcd12864_show_string(0,0,table31);
 192   4                      lcd12864_show_string(1,0,table00);
 193   4                      lcd12864_show_string(2,0,table00);
 194   4                  lcd12864_show_string(3,0,table00);
 195   4                              lcd12864_show_string(3,5,table8);
 196   4                      }       
 197   3      
 198   3                        if( KeyValue==4 && flag_function==4 )
 199   3                       {
 200   4                         
 201   4                          //lcd12864_init();
 202   4                              flag_shezhijiemian=1;
 203   4                      lcd12864_show_string(0,0,table41);
 204   4                      lcd12864_show_string(1,0,table42);
 205   4                      lcd12864_show_string(2,0,table43);
 206   4                              lcd12864_show_string(3,0,table00);
 207   4                  lcd12864_show_string(3,5,table8);
 208   4           
 209   4                      }
 210   3                         KeyValue=17;
 211   3              }
 212   2      
 213   2                //二级菜单 ――――密码开锁界面
 214   2                 if(flag_mimakaisuo==1)
 215   2                 {
 216   3                    if(KeyValue!=17)
 217   3                        {              
 218   4                                        if(KeyValue<10)
 219   4                                        {
 220   5                                            if(index<6)
 221   5                                                {
 222   6                                                         mima_edit[index++]=KeyValue;
 223   6                                                         lcd12864_show_char(1,index-1,KeyValue+'0');
 224   6                                                         KeyValue=17;
 225   6                                                }else
 226   5                                                {
 227   6      
 228   6                                                }
 229   5                                              
 230   5                                        }else
 231   4                                        {
 232   5                                          if(KeyValue==10)
 233   5                                              {               KeyValue=17;
 234   6                                                 //删除一位
 235   6                                                 if(index>0 && index<=6)
 236   6                                                 {
 237   7                                                      mima_edit[index-1]=0Xff;
 238   7                                                  lcd12864_show_char(1,index-1,' ');
 239   7                                                  index-=1;
 240   7                                              
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 5   

 241   7                                                 }
 242   6                                                 
 243   6                                                 else if(index>6)
 244   6                                                 {   
 245   7                                                      index=6;
 246   7                                                  lcd12864_show_char(1,index-1,' ');
 247   7                                                  mima_edit[index-1]=0Xff;
 248   7                                                  index-=1;
 249   7                                                 
 250   7                                                 }else
 251   6                                                 {
 252   7                                                 //index为0，不操作
 253   7      
 254   7                                                 }
 255   6                                                 
 256   6                                              }
 257   5                                              
 258   5                                              else if(KeyValue==11)
 259   5                                              {
 260   6                                               //确认
 261   6                                                KeyValue=17;
 262   6                                                 if(checkmima(mima,mima_edit))
 263   6                                                 {
 264   7                                                        //密码正确开锁,提示
 265   7                                  lcd12864_show_string(0,0,table9);                
 266   7                                  lcd12864_show_string(1,0,table00);
 267   7                                  lcd12864_show_string(2,0,table00);
 268   7                              lcd12864_show_string(3,0,table00);
 269   7                                                      index=0;
 270   7                                                       
 271   7                                                 } else
 272   6                                                 {
 273   7                                                       //密码错误，提示,并清空密码
 274   7                                                       uchar i;
 275   7                                                       for(i=0;i<6;i++)
 276   7                                                       lcd12864_show_char(1,i,' ');
 277   7                                                       index=0;
 278   7                                                       
 279   7                                                 }
 280   6                                                 //清除输入的密码
 281   6                                                      mima_edit[0]=0xff;
 282   6                                                      mima_edit[1]=0xff;
 283   6                                                      mima_edit[2]=0xff;
 284   6                                                      mima_edit[3]=0xff;
 285   6                                                      mima_edit[4]=0xff;
 286   6                                                      mima_edit[5]=0xff;
 287   6                                              }
 288   5      
 289   5                                              else if(KeyValue==12)
 290   5                                              {
 291   6                                                //退出
 292   6                                                 KeyValue=17;
 293   6                                                 flag_mimakaisuo=0;
 294   6                                                 lcd12864_show_string(0,1,table1);
 295   6                                 lcd12864_show_string(1,1,table2);
 296   6                                 lcd12864_show_string(2,1,table3);
 297   6                             lcd12864_show_string(3,1,table4);
 298   6                             lcd12864_show_string(3,5,table5);
 299   6      
 300   6                                                 //清除输入的密码
 301   6                                                  mima_edit[0]=0xff;
 302   6                                                      mima_edit[1]=0xff;
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 6   

 303   6                                                      mima_edit[2]=0xff;
 304   6                                                      mima_edit[3]=0xff;
 305   6                                                      mima_edit[4]=0xff;
 306   6                                                      mima_edit[5]=0xff;
 307   6                                                      index=0;
 308   6                                              
 309   6                                              }else
 310   5                                              {
 311   6                                                //此种按键码无效
 312   6                                                 KeyValue=17;
 313   6                                              }
 314   5                                        }
 315   4      
 316   4                               
 317   4                        }
 318   3                       
 319   3      
 320   3                 }
 321   2      
 322   2                      //二级菜单 ――――指纹开锁界面
 323   2                 if(flag_zhiwenkaisuo==1)
 324   2                 {
 325   3                               lcd12864_show_string(0,0,"请输入指纹  ");
 326   3                       lcd12864_show_string(1,1,table00);
 327   3                       lcd12864_show_string(2,1,table00);
 328   3                   lcd12864_show_string(3,1,table00);
 329   3                               do
 330   3                              {
 331   4                                                      //获得指纹图像
 332   4                                                      for(i=0;i<12;i++)
 333   4                                                      {
 334   5                                                        Uart_Send_Byte(zhiwen_in[i]);
 335   5                                                      }
 336   4                                                      for(i=0;i<12;i++)
 337   4                                                      {
 338   5                                                        buff_zhiwen[i]=Uart_Receive_Byte();
 339   5                                                      }               
 340   4                                      //判断接收到的确认码,等于0指纹获取成功
 341   4                                      if(buff_zhiwen[9]==0)
 342   4                                      {                       
 343   5                                                Delay100ms();
 344   5                                              for(i=0;i<13;i++)//存入buffer1
 345   5                                              {
 346   6                                                Uart_Send_Byte(zhiwen_product[i]);
 347   6                                              }
 348   5                                              for(i=0;i<12;i++)
 349   5                                              {
 350   6                                                buff_zhiwen[i]=Uart_Receive_Byte();
 351   6                                              }               
 352   5                                              for(i=0;i<17;i++)//serach指纹
 353   5                                              {
 354   6                                                Uart_Send_Byte(zhiwen_search[i]);
 355   6                                              }
 356   5                                              for(i=0;i<16;i++)
 357   5                                              {
 358   6                                                buff_zhiwen[i]=Uart_Receive_Byte();
 359   6                                              }                       
 360   5                                                if(buff_zhiwen[9] == 0) //搜索到  
 361   5                                                      {                                               
 362   6                                                 lcd12864_show_string(0,0,"指纹开锁成功    ");
 363   6                                 lcd12864_show_string(1,1,table00);
 364   6                                 lcd12864_show_string(2,1,table00);
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 7   

 365   6                             lcd12864_show_string(3,1,table00);
 366   6                                                        while(1);                             
 367   6                                                 }
 368   5                                                 else //没有找到
 369   5                                                      {
 370   6                                                 lcd12864_show_string(0,1,"请输入指纹      ");
 371   6                                 lcd12864_show_string(1,1,"未找到指纹信息  ");
 372   6                                 lcd12864_show_string(2,1,table00);
 373   6                             lcd12864_show_string(3,1,table00);
 374   6                                                      }
 375   5                                              }               
 376   4                                      }while(1);
 377   3                 }
 378   2      
 379   2                      //二级菜单 ――――蓝牙开锁界面
 380   2                 if(flag_lanyakaisuo==1)
 381   2                 {
 382   3                              for(i=0;i<15;i++)
 383   3                              {
 384   4                               buff_lanya[i]=Uart_Receive_Byte();
 385   4                              }
 386   3                              if(flag_lanyakaisuo_bao)
 387   3                              {
 388   4                                       if(checklanay(buff_lanya)&&flag_success_laya==0)
 389   4                                       {
 390   5                                       //开锁成功
 391   5                             lcd12864_show_string(0,1,table32);
 392   5                                 lcd12864_show_string(1,1,table00);
 393   5                                 lcd12864_show_string(2,1,table00);
 394   5                             lcd12864_show_string(3,1,table00);
 395   5                                  sendstring("#C!");//成功回复
 396   5                                                      sendstring("#C!");
 397   5                                                      sendstring("#C!");
 398   5                                                      sendstring("#C!");
 399   5                                                      sendstring("#C!");
 400   5                                                      flag_success_laya=1;
 401   5      
 402   5                                       }
 403   4                                      
 404   4                                       for(i=0;i<20;i++)
 405   4                                       {
 406   5                                        buff_lanya[i]=0;
 407   5                                        }
 408   4                                      
 409   4                                       num_laya_i=0;
 410   4                                       num_laya_bao=0;
 411   4                                       flag_lanyakaisuo_bao=0;//数据包已经足够，可以判断开锁
 412   4                                       
 413   4                              }
 414   3                      if(KeyValue==12)
 415   3                              {                  flag_success_laya=0;
 416   4                                             flag_lanyakaisuo=0;
 417   4                                             KeyValue=17;
 418   4                                                 flag_lanyakaisuo=0;
 419   4                                                 lcd12864_show_string(0,1,table1);
 420   4                                 lcd12864_show_string(1,1,table2);
 421   4                                 lcd12864_show_string(2,1,table3);
 422   4                             lcd12864_show_string(3,1,table4);
 423   4                             lcd12864_show_string(3,5,table5);
 424   4      
 425   4                              }
 426   3      
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 8   

 427   3                 }
 428   2      
 429   2                //二级菜单 ――――设置界面    
 430   2                 if(flag_shezhijiemian==1)
 431   2                 {
 432   3                              if(KeyValue==0&&flag_mima_set==0)
 433   3                              {
 434   4                               KeyValue=17;
 435   4                               flag_mima_set=1;
 436   4                              //密码设置         请输入密码：     10 删除        11 确认     12 取消
 437   4                              lcd12864_show_string(0,1,table11);
 438   4                              lcd12864_show_string(1,1,table00);
 439   4                      lcd12864_show_string(2,1,table6);
 440   4                      lcd12864_show_string(3,1,table7);
 441   4                  lcd12864_show_string(3,5,table8);
 442   4                              }
 443   3                              if(KeyValue==1&&flag_zhiwen_set==0)
 444   3                              {
 445   4                               KeyValue=17;
 446   4                               flag_zhiwen_set=1;
 447   4                               lcd12864_show_string(0,0,"  请录入指纹  ");
 448   4                       lcd12864_show_string(1,1,table00);
 449   4                       lcd12864_show_string(2,1,table00);
 450   4                   lcd12864_show_string(3,1,table00);
 451   4                              }
 452   3                              if(flag_mima_set)
 453   3                              {
 454   4                                 if(KeyValue<10)
 455   4                                        {
 456   5                                              //KeyValue=17;
 457   5                                              if(index<6)
 458   5                                                 {
 459   6                                                      mima_set[index++]=KeyValue;
 460   6                                                  lcd12864_show_char(1,index-1,KeyValue+'0');
 461   6                                                      KeyValue=17;
 462   6                                                 }
 463   5                                                 else 
 464   5                                                 {  
 465   6      
 466   6                                                 }
 467   5                                        }
 468   4                                        else if(KeyValue==10)
 469   4                                        {
 470   5                                                  KeyValue=17;
 471   5                                                  if(index>0 && index<=6)
 472   5                                                 {
 473   6                                                      mima_set[index-1]=0Xff;
 474   6                                                  lcd12864_show_char(1,index-1,' ');
 475   6                                                  index-=1;
 476   6                                              
 477   6                                                 }
 478   5                                                 
 479   5                                                 else if(index>6)
 480   5                                                 {   
 481   6                                                      index=6;
 482   6                                                  lcd12864_show_char(1,index-1,' ');
 483   6                                                  mima_edit[index-1]=0Xff;
 484   6                                                  index-=1;
 485   6                                                 
 486   6                                                 }else
 487   5                                                 {
 488   6                                                 //index为0，不操作
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 9   

 489   6                                                 }
 490   5      
 491   5                                        }     else if(KeyValue==11)
 492   4                                        {
 493   5                                                  KeyValue=17;
 494   5                                                  At24c02Write(0x00,mima_set[0]);
 495   5                                                      delay10ms();
 496   5                                                      At24c02Write(0x01,mima_set[1]);
 497   5                                                      delay10ms();
 498   5                                                      At24c02Write(0x02,mima_set[2]);
 499   5                                                      delay10ms();
 500   5                                                      At24c02Write(0x03,mima_set[3]);
 501   5                                                      delay10ms();
 502   5                                                      At24c02Write(0x04,mima_set[4]);
 503   5                                                      delay10ms();
 504   5                                                      At24c02Write(0x05,mima_set[5]);
 505   5                                                      delay10ms();
 506   5                                                      mima[0]=mima_set[0];
 507   5                                                      mima[1]=mima_set[1];
 508   5                                                      mima[2]=mima_set[2];
 509   5                                                      mima[3]=mima_set[3];
 510   5                                                      mima[4]=mima_set[4];
 511   5                                                      mima[5]=mima_set[5];
 512   5      
 513   5      
 514   5                                        }     else if(KeyValue==12)
 515   4                                        {
 516   5                                                 KeyValue=17;
 517   5                                                 index=0;
 518   5                                                // shezhi_mima=0;
 519   5                                                 //flag_shezhijiemian=0;
 520   5                                                 flag_mima_set=0;
 521   5                                                 lcd12864_show_string(1,0,table00);
 522   5                                                 lcd12864_show_string(0,1,table1);
 523   5                                 lcd12864_show_string(1,1,table2);
 524   5                                 lcd12864_show_string(2,1,table3);
 525   5                             lcd12864_show_string(3,1,table4);
 526   5                             lcd12864_show_string(3,5,table5);
 527   5      
 528   5                                        }else
 529   4                                        {
 530   5                                               // KeyValue=17;
 531   5                                        }
 532   4                              }
 533   3                              if(flag_zhiwen_set)
 534   3                              {
 535   4                                      
 536   4                                      do
 537   4                                         {
 538   5                                                      //获得指纹图像
 539   5                                                      for(i=0;i<12;i++)
 540   5                                                      {
 541   6                                                        Uart_Send_Byte(zhiwen_in[i]);
 542   6                                                      }
 543   5                                                      for(i=0;i<12;i++)
 544   5                                                      {
 545   6                                                        buff_zhiwen[i]=Uart_Receive_Byte();
 546   6                                                      }
 547   5                                                      //判断接收到的确认码,等于0指纹获取成功
 548   5                                                      if(buff_zhiwen[9]==0)
 549   5                                                       {
 550   6                                                              Delay100ms();
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 10  

 551   6                                                              for(i=0;i<13;i++)//存入buffer1
 552   6                                                              {
 553   7                                                                Uart_Send_Byte(zhiwen_product[i]);
 554   7                                                              }
 555   6                                                              for(i=0;i<12;i++)
 556   6                                                              {
 557   7                                                                buff_zhiwen[i]=Uart_Receive_Byte();
 558   7                                                              }
 559   6                                                              Delay100ms();Delay100ms();Delay100ms();Delay100ms();Delay100ms();
 560   6                                                              do
 561   6                                                              {
 562   7                                                                //获得指纹图像
 563   7                                                                      for(i=0;i<12;i++)
 564   7                                                                              {
 565   8                                                                                Uart_Send_Byte(zhiwen_in[i]);
 566   8                                                                              }
 567   7                                                                      for(i=0;i<12;i++)
 568   7                                                                              {
 569   8                                                                                buff_zhiwen[i]=Uart_Receive_Byte();
 570   8                                                                              }
 571   7                                                              //判断接收到的确认码,等于0指纹获取成功
 572   7                                                              if(buff_zhiwen[9]==0)
 573   7                                                               {
 574   8                                                                      Delay100ms();
 575   8                                                                      for(i=0;i<13;i++)//存入buffer2
 576   8                                                                              {
 577   9                                                                                Uart_Send_Byte(zhiwen_product2[i]);
 578   9                                                                              }
 579   8                                                                      for(i=0;i<12;i++)
 580   8                                                                              {
 581   9                                                                                buff_zhiwen[i]=Uart_Receive_Byte();
 582   9                                                                              }
 583   8                                                                      //转换成特征码
 584   8                                                                      for(i=0;i<12;i++)
 585   8                                                                              {
 586   9                                                                              Uart_Send_Byte(zhiwen_get[i]);
 587   9                                                                              }
 588   8                                                                      
 589   8                                                      for(i=0;i<12;i++)
 590   8                                                                      {
 591   9                                                                        buff_zhiwen[i]=Uart_Receive_Byte();
 592   9                                                                      } 
 593   8      
 594   8                                                                for(i=0;i<15;i++)//将buffer1放入指纹库0位
 595   8                                                                        {
 596   9                                                                               Uart_Send_Byte(zhiwen_str[i]);
 597   9                                                                        } 
 598   8                                                                                               
 599   8                                                      for(i=0;i<12;i++)
 600   8                                                                      {
 601   9                                                                        buff_zhiwen[i]=Uart_Receive_Byte();
 602   9                                                                      }
 603   8                                                                      //指纹录入成功
 604   8                                                                         lcd12864_show_string(0,1,table00);
 605   8                                                         lcd12864_show_string(1,1,table00);
 606   8                                                                         lcd12864_show_string(1,1,table51);
 607   8                                                         lcd12864_show_string(2,1,table00);
 608   8                                                     lcd12864_show_string(3,1,table00);
 609   8                                                     lcd12864_show_string(3,5,table8);
 610   8                                                                          KeyValue=17;
 611   8                                                              //      Delay100ms();Delay100ms();Delay100ms();Delay100ms();Delay100ms();
 612   8                                                                      Delay100ms();Delay100ms();Delay100ms();Delay100ms();Delay100ms();
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 11  

 613   8                                                          break;
 614   8                                                              }
 615   7                                                         }while(1);
 616   6                                                              break;
 617   6                                                              }
 618   5                                                      }while(1);
 619   4                                                 flag_zhiwen_set=0; //返回设置界面
 620   4      //                                         lcd12864_show_string(1,0,table00);
 621   4      //                                         lcd12864_show_string(0,1,table1);
 622   4      //                         lcd12864_show_string(1,1,table2);
 623   4      //                         lcd12864_show_string(2,1,table3);
 624   4      //                       lcd12864_show_string(3,1,table4);
 625   4      //                       lcd12864_show_string(3,5,table5);
 626   4                                                 KeyValue=17;
 627   4                                                
 628   4                              }
 629   3                   
 630   3                              if(KeyValue==12)
 631   3                              {
 632   4                                 //退出
 633   4                                 KeyValue=17;
 634   4                                 flag_shezhijiemian=0;
 635   4                                 
 636   4                                 lcd12864_show_string(0,1,table1);
 637   4                         lcd12864_show_string(1,1,table2);
 638   4                         lcd12864_show_string(2,1,table3);
 639   4                         lcd12864_show_string(3,1,table4);
 640   4                         lcd12864_show_string(3,5,table5);
 641   4                              }
 642   3                 }
 643   2      }
 644   1      
 645   1         }
 646          
 647           uchar checkmima(uchar mima[],uchar mima_edit[])
 648           {
 649   1                  uchar i=0,j=0;
 650   1                      for(i=0;i<6;i++)
 651   1                      {
 652   2                         if(mima[i]==mima_edit[i])
 653   2                         {
 654   3                                       j++;
 655   3                         }
 656   2                      }
 657   1                      
 658   1                      if(j==6)
 659   1                         return 1;
 660   1                      else
 661   1                              return 0;
 662   1       }
 663          
 664          
 665          
 666          void init()
 667          {
 668   1          lcd12864_init();
 669   1              lcd12864_show_string(0,1,table1);
 670   1              lcd12864_show_string(1,1,table2);
 671   1              lcd12864_show_string(2,1,table3);
 672   1              lcd12864_show_string(3,1,table4);
 673   1              lcd12864_show_string(3,5,table5);
 674   1              mima[0]=1;
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 12  

 675   1              mima[1]=2;
 676   1              mima[2]=3;
 677   1              mima[3]=4;
 678   1              mima[4]=5;
 679   1              mima[5]=6;
 680   1      
 681   1      }
 682          
 683          
 684          
 685          void UsartConfiguration()
 686          {
 687   1              PCON &= 0x7F;           //波特率不倍速
 688   1              SCON = 0x50;            //8位数据,可变波特率
 689   1              TMOD &= 0x0F;           //清除定时器1模式位
 690   1              TMOD |= 0x20;           //设定定时器1为8位自动重装方式
 691   1              TL1 = 0xFD;             //设定定时初值
 692   1              TH1 = 0xFD;             //设定定时器重装值
 693   1              ET1 = 0;                //禁止定时器1中断
 694   1              TR1 = 1;                //启动定时器1
 695   1              EA=1;
 696   1      }
 697          
 698          //void Usart() interrupt 4
 699          //{
 700          //      uchar receiveData,receiveData_zhiwen;
 701          //      receiveData=SBUF;
 702          //      //蓝牙开锁界面   
 703          //         if(flag_lanyakaisuo_bao==0 && flag_lanyakaisuo==1)
 704          //         {
 705          //                 buff_lanya[num_laya_i++]= receiveData;
 706          //                 if(receiveData=='#')
 707          //                      num_laya_bao++; 
 708          //                      if(num_laya_bao>2)
 709          //                         flag_lanyakaisuo_bao=1;  
 710          //         }
 711          //      //      指纹开锁界面
 712          //        if(RI)
 713          //         {
 714          //                      receiveData_zhiwen=SBUF;
 715          //                      buff_zhiwen[num_test++]= receiveData_zhiwen;
 716          //                  RI = 0;
 717          //                      flag_zhiwenkaisuo_bao=1;
 718          //
 719          //         }
 720          //     
 721          //      RI = 0; 
 722          ////    EA=1;          //清除接收中断标志位
 723          ////    SBUF=receiveData; //将接收到的数据放入到发送寄存器
 724          ////    while(!TI);               //等待发送数据完成
 725          ////    TI=0;                     //清除发送完成标志位
 726          //}
 727          
 728          void sendchar(uchar ch)
 729          {
 730   1              SBUF=ch; //将接收到的数据放入到发送寄存器
 731   1              while(!TI);               //等待发送数据完成
 732   1              TI=0;   
 733   1      }
 734          
 735          
 736          void sendstring(uchar *s)
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 13  

 737          {
 738   1         while (*s)              
 739   1          {
 740   2              sendchar(*s++);     
 741   2          }
 742   1      }
 743          
 744          void sendstring_zhiwen(uchar *s ,uchar length)
 745          {
 746   1         while (length!=0)              
 747   1          {
 748   2              sendchar(*s++);
 749   2                      length--;     
 750   2          }
 751   1      }
 752          
 753          uchar checklanay(uchar buff_lanya[])
 754          {
 755   1              uchar i=0;
 756   1                 for(i=0;i<20-3;i++)
 757   1                 {
 758   2                         if(buff_lanya[i]=='#')
 759   2                         {
 760   3                             if(buff_lanya[i+1]=='K'&&buff_lanya[i+2]=='!')
 761   3                                 {
 762   4                                        return 1;
 763   4                                 }
 764   3                         }
 765   2                 }
 766   1                 return 0;
 767   1      }
 768          
 769          void delay10ms()                //@11.0592MHz
 770          {
 771   1              unsigned char i, j;
 772   1      
 773   1              i = 108;
 774   1              j = 145;
 775   1              do
 776   1              {
 777   2                      while (--j);
 778   2              } while (--i);
 779   1      }
 780          
 781          
 782          void Delay100ms()               //@11.0592MHz
 783          {
 784   1              unsigned char i, j, k;
 785   1      
 786   1              _nop_();
 787   1              _nop_();
 788   1              i = 5;
 789   1              j = 52;
 790   1              k = 195;
 791   1              do
 792   1              {
 793   2                      do
 794   2                      {
 795   3                              while (--k);
 796   3                      } while (--j);
 797   2              } while (--i);
 798   1      }
C51 COMPILER V9.01   MAIN                                                                  01/14/2019 20:27:29 PAGE 14  

 799          
 800          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3371    ----
   CONSTANT SIZE    =    342    ----
   XDATA SIZE       =    168      17
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
